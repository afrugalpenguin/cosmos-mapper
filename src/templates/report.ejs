<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cosmos DB Schema Documentation</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/panzoom@9.4.3/dist/panzoom.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            cosmos: {
              50: '#eff6ff',
              100: '#dbeafe',
              200: '#bfdbfe',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8',
              800: '#1e40af',
              900: '#1e3a8a',
            }
          }
        }
      }
    }
  </script>
  <style>
    .mermaid { background: transparent; }
    details summary { cursor: pointer; }
    details summary::-webkit-details-marker { display: none; }
    details[open] summary .chevron { transform: rotate(90deg); }
    .chevron { transition: transform 0.2s; }
    .diagram-container {
      position: relative;
      overflow: hidden;
      min-height: 400px;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      background: #f9fafb;
    }
    .diagram-viewport {
      width: 100%;
      height: 100%;
      cursor: grab;
    }
    .diagram-viewport:active { cursor: grabbing; }
    .diagram-controls {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      display: flex;
      gap: 0.25rem;
      z-index: 10;
    }
    .diagram-controls button {
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      cursor: pointer;
      font-weight: bold;
      color: #374151;
      transition: all 0.15s;
    }
    .diagram-controls button:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="bg-gradient-to-r from-cosmos-700 to-cosmos-900 text-white shadow-lg">
    <div class="px-4 py-6 sm:px-6 lg:px-8">
      <div class="flex items-center gap-4">
        <div class="bg-white/10 p-3 rounded-lg">
          <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
        </div>
        <div>
          <h1 class="text-2xl font-bold">Cosmos DB Schema Documentation</h1>
          <p class="text-cosmos-200 text-sm">Generated: <%= timestamp %></p>
        </div>
      </div>
    </div>
  </header>

  <main class="px-4 py-8 sm:px-6 lg:px-8">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center">
          <div class="p-3 bg-blue-100 rounded-lg">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-500">Databases</p>
            <p class="text-2xl font-bold text-gray-900"><%= Object.keys(databases).length %></p>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center">
          <div class="p-3 bg-green-100 rounded-lg">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-500">Containers</p>
            <p class="text-2xl font-bold text-gray-900"><%= Object.keys(containerSchemas).length %></p>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center">
          <div class="p-3 bg-purple-100 rounded-lg">
            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-500">Relationships</p>
            <p class="text-2xl font-bold text-gray-900"><%= relationships.filter(r => !r.isOrphan).length %></p>
          </div>
        </div>
      </div>
    </div>

    <!-- ERD Diagram -->
    <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
      <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-cosmos-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/>
        </svg>
        Entity Relationship Diagram
      </h2>
      <div class="diagram-container" style="height: 85vh; min-height: 600px;">
        <div class="diagram-controls">
          <button onclick="zoomIn(this)" title="Zoom In">+</button>
          <button onclick="zoomOut(this)" title="Zoom Out">−</button>
          <button onclick="resetZoom(this)" title="Reset">⟲</button>
        </div>
        <div class="diagram-viewport">
          <pre class="mermaid">
<%- simpleERD %>
          </pre>
        </div>
      </div>
      <div class="mt-4 text-sm text-gray-500 flex flex-wrap gap-4">
        <span><code class="bg-gray-100 px-2 py-1 rounded">||</code> Exactly one</span>
        <span><code class="bg-gray-100 px-2 py-1 rounded">o|</code> Zero or one</span>
        <span><code class="bg-gray-100 px-2 py-1 rounded">}o</code> Zero or more</span>
        <span><code class="bg-gray-100 px-2 py-1 rounded">}|</code> One or more</span>
      </div>
    </section>

    <!-- Databases -->
    <% for (const [dbName, dbInfo] of Object.entries(databases)) { %>
    <section class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6 overflow-hidden">
      <div class="bg-gradient-to-r from-gray-50 to-white px-6 py-4 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
          <svg class="w-5 h-5 text-cosmos-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
          </svg>
          <%= dbName %>
          <span class="text-sm font-normal text-gray-500">(<%= dbInfo.containers.length %> containers)</span>
        </h2>
      </div>

      <div class="p-6">
        <!-- Database ERD -->
        <% if (databaseERDs[dbName]) { %>
        <details class="mb-6" open>
          <summary class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-3">
            <svg class="w-4 h-4 chevron text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            Database ERD
          </summary>
          <div class="diagram-container" style="height: 600px;">
            <div class="diagram-controls">
              <button onclick="zoomIn(this)" title="Zoom In">+</button>
              <button onclick="zoomOut(this)" title="Zoom Out">−</button>
              <button onclick="resetZoom(this)" title="Reset">⟲</button>
            </div>
            <div class="diagram-viewport">
              <pre class="mermaid">
<%- databaseERDs[dbName] %>
              </pre>
            </div>
          </div>
        </details>
        <% } %>

        <!-- Containers -->
        <% for (const containerName of dbInfo.containers) { %>
        <% const schema = containerSchemas[`${dbName}.${containerName}`] || containerSchemas[containerName]; %>
        <% if (schema) { %>
        <% const containerRels = relationships.filter(r => r.fromContainer === containerName && r.fromDatabase === dbName && !r.isOrphan); %>
        <details class="border border-gray-200 rounded-lg mb-4">
          <summary class="flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors rounded-t-lg">
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4 chevron text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
              <span class="font-semibold text-gray-900"><%= containerName %></span>
            </div>
            <div class="flex gap-2">
              <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-700 rounded-full">
                <%= getRootProperties(schema.properties).length %> properties
              </span>
              <% if (containerRels.length > 0) { %>
              <span class="px-2 py-1 text-xs font-medium bg-purple-100 text-purple-700 rounded-full">
                <%= containerRels.length %> relationships
              </span>
              <% } %>
            </div>
          </summary>
          <div class="p-4">
            <!-- Properties Table -->
            <table class="min-w-full divide-y divide-gray-200 mb-4">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Property</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Required</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Example</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <% for (const prop of getRootProperties(schema.properties)) { %>
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-2 text-sm font-medium text-gray-900">
                    <%= prop.name %>
                    <% if (prop.name === 'id') { %>
                    <span class="ml-1 px-1.5 py-0.5 text-xs font-medium bg-yellow-100 text-yellow-800 rounded">ID</span>
                    <% } %>
                    <% if (containerRels.some(r => r.fromProperty === prop.name)) { %>
                    <span class="ml-1 px-1.5 py-0.5 text-xs font-medium bg-purple-100 text-purple-800 rounded">REF</span>
                    <% } %>
                  </td>
                  <td class="px-4 py-2 text-sm text-gray-600">
                    <%= prop.types.map(t => getTypeDisplayName(t)).join(' | ') %>
                  </td>
                  <td class="px-4 py-2 text-sm">
                    <% if (prop.isRequired) { %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">Yes</span>
                    <% } else { %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600">No</span>
                    <% } %>
                  </td>
                  <td class="px-4 py-2 text-sm text-gray-500 font-mono text-xs max-w-xs truncate">
                    <%= prop.examples && prop.examples[0] ? prop.examples[0] : '-' %>
                  </td>
                </tr>
                <% } %>
              </tbody>
            </table>

            <!-- Relationships -->
            <% if (containerRels.length > 0) { %>
            <div class="mt-4 pt-4 border-t border-gray-200">
              <h4 class="text-sm font-medium text-gray-700 mb-2">Outgoing Relationships</h4>
              <div class="flex flex-wrap gap-2">
                <% for (const rel of containerRels) { %>
                <div class="inline-flex items-center px-3 py-1.5 rounded-full text-sm bg-purple-50 text-purple-700 border border-purple-200">
                  <span class="font-medium"><%= rel.fromProperty %></span>
                  <svg class="w-4 h-4 mx-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                  </svg>
                  <span><%= rel.toContainer %></span>
                  <% if (rel.isCrossDatabase) { %>
                  <span class="ml-1 text-xs text-purple-500">(<%= rel.toDatabase %>)</span>
                  <% } %>
                </div>
                <% } %>
              </div>
            </div>
            <% } %>
          </div>
        </details>
        <% } %>
        <% } %>
      </div>
    </section>
    <% } %>

    <!-- Cross-Database Relationships -->
    <% const crossDbRels = relationships.filter(r => r.isCrossDatabase && !r.isOrphan); %>
    <% if (crossDbRels.length > 0) { %>
    <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
      <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
        </svg>
        Cross-Database Relationships
      </h2>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Source</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Property</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Target</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <% for (const rel of crossDbRels) { %>
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-2 text-sm">
                <span class="font-medium text-gray-900"><%= rel.fromDatabase %></span>.<%= rel.fromContainer %>
              </td>
              <td class="px-4 py-2 text-sm font-mono text-purple-600"><%= rel.fromProperty %></td>
              <td class="px-4 py-2 text-sm">
                <span class="font-medium text-gray-900"><%= rel.toDatabase %></span>.<%= rel.toContainer %>
              </td>
              <td class="px-4 py-2 text-sm text-gray-500"><%= rel.cardinality %></td>
            </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </section>
    <% } %>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-100 border-t border-gray-200 mt-12">
    <div class="px-4 py-6 sm:px-6 lg:px-8">
      <p class="text-center text-sm text-gray-500">
        Generated by <a href="https://github.com/afrugalpenguin/cosmos-mapper" class="text-cosmos-600 hover:underline">CosmosMapper</a>
      </p>
    </div>
  </footer>

  <script>
    // Initialize Mermaid
    mermaid.initialize({
      startOnLoad: true,
      theme: 'base',
      themeVariables: {
        primaryColor: '#dbeafe',
        primaryTextColor: '#1e40af',
        primaryBorderColor: '#3b82f6',
        lineColor: '#6b7280',
        secondaryColor: '#f3f4f6',
        tertiaryColor: '#fff'
      }
    });

    // Store panzoom instances
    const panzoomInstances = new WeakMap();

    // Initialize panzoom on all diagram viewports after Mermaid renders
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        document.querySelectorAll('.diagram-viewport').forEach(viewport => {
          const instance = panzoom(viewport, {
            maxZoom: 5,
            minZoom: 0.25,
            initialZoom: 1,
            bounds: true,
            boundsPadding: 0.1
          });
          panzoomInstances.set(viewport, instance);
        });
      }, 500); // Wait for Mermaid to render
    });

    function getViewport(button) {
      return button.closest('.diagram-container').querySelector('.diagram-viewport');
    }

    function zoomIn(button) {
      const viewport = getViewport(button);
      const instance = panzoomInstances.get(viewport);
      if (instance) {
        const transform = instance.getTransform();
        instance.zoomAbs(viewport.clientWidth / 2, viewport.clientHeight / 2, transform.scale * 1.3);
      }
    }

    function zoomOut(button) {
      const viewport = getViewport(button);
      const instance = panzoomInstances.get(viewport);
      if (instance) {
        const transform = instance.getTransform();
        instance.zoomAbs(viewport.clientWidth / 2, viewport.clientHeight / 2, transform.scale / 1.3);
      }
    }

    function resetZoom(button) {
      const viewport = getViewport(button);
      const instance = panzoomInstances.get(viewport);
      if (instance) {
        instance.moveTo(0, 0);
        instance.zoomAbs(0, 0, 1);
      }
    }
  </script>
</body>
</html>
